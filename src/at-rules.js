import {flatIter} from './helpers'
import {sheet} from './sheet'
import {declarations} from './declarations'

/**
 * Hanldes at-rules
 *
 * @param {string} k - The at-rule name, and, if takes both parameters and a
 *                     block, the parameters.
 * @param {string[]} emit - the contextual emitters to the final buffer
 * @param {string[]} v - Either parameters for block-less rules or their block
 *                       for the others.
 * @param {string} prefix - the current selector or a prefix in case of nested rules
 * @param {string} composes - the potential target of a @composes rule, if any
 * @param {boolean} local - are we in @local or in @global scope?
 * @param {function} localize - @local helper
 */

export function atRules(k, v, emit, prefix, composes, local, localize){
  k = /^(.(?:-[\w]+-)?([_A-Za-z][-\w]*))\b\s*(.*?)\s*$/.exec(k) || ['@','@','','']
  if (!k[3] && /^global$/.test(k[2])) {
    sheet(v, emit, prefix, 1, 0, localize)

  } else if (!k[3] && /^local$/.test(k[2])) {

    sheet(v, emit, prefix, 1, 1, localize)

  } else if (!k[3] && /^mixin$/.test(k[2])) {

    sheet(v, emit, prefix, composes, local, localize)

  } else if (!k[3] && /^(?:namespace|import|charset)$/.test(k[2])) {
    flatIter(function(v) {

      emit.a(k[0], ' ', v, ';\n')

    })(v)

  } else if (!k[3] && /^(?:font-face|viewport|swash|ornaments|annotation|stylistic|styleset|character-variant)$/.test(k[2])) {
    flatIter(function(v) {

      emit.a(k[1], '', '', ' {\n')

      declarations(v, emit, '', local, localize)

      emit.c('}\n')

    })(v)

  } else if (k[3] && /^(?:media|supports|document|page|keyframes|counter-style|font-feature-values)$/.test(k[2])) {

    if (local && /^(?:keyframes|counter-style)$/.test(k[2])) {
      k[3] = k[3].replace(
        // generated by script/regexps.js
        /:?global\(\s*([_A-Za-z][-\w]*)\s*\)|()(-?[_A-Za-z][-\w]*)/,
        localize
      )
    }


    emit.a(k[1], ' ', k[3], ' {\n')

    if (/^(?:page|counter-style)$/.test(k[2])) {

      declarations(v, emit, '', local, localize)

    } else {

      sheet(v, emit, prefix, 1, local, localize)

    }

    emit.c('}\n')

  } else {
    for (var i = 0; i < localize.a.length; i++) {
      if (localize.a[i](k, v, emit, prefix, composes, local, localize, sheet, declarations)) return
    }
    emit.a('@-error-unsupported-at-rule', ' ', JSON.stringify(k[0]), ';\n')

  }
}
