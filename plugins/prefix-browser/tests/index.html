<!doctype html>
<title>j2c prefix plugin live test</title>
<script src='../../../dist/j2c.global.js'></script>
<script src='../dist/j2c-plugin-prefix-browser.global.js'></script>
<h1>j2c-plugin-prefix-browser in action in your browser</h1>
<pre id="source"></pre>
<pre id="prefixed"></pre>
<script>
var src = {
  '@global': {
    '@keyframes rotate': {
      'from': {
        transform: 'rotate(15deg)'
      },
      'to': {
        transform: 'rotate(375deg)'
      }
    },
    '@supports (display:flex)':{
       ':read-write ::placeholder': {
          userSelect: 'none',
          appearance: 'none',
          display: 'flex',
          flex: '1 1',
          flexFlow: 'column-reverse wrap'
      },
    },
    '@media (min-resolution:2dppx)' : {
     '.download': {
        backgroundImage: 'linear-gradient(90deg, red, rgba(calc(10 * 2),0,0,.3))',
        color: 'white',
        textDecoration: 'initial',
        textShadow: '.08em .08em .2em rgba(0,0,0,.6)',
        borderRadius: '50%',
        boxShadow: '.1em .2em .4em -.2em black',
        boxSizing: 'border-box',
        transform: 'rotate(15deg)',
        animation: 'rotate',
        cursor: 'zoom-in'
      }        
    }
  }
}

// the bottom of the 'codegen' stream. Mirrors the `filter` plugin API.
var sink = {sink: function(){
  var buf, err, indent
  return [{
    init: function(){buf=[], err=0, indent = ''},
    done: function (raw) {
      if (err) throw new Error('j2c error, see below\n' + buf.join(''))
      return raw ? buf : buf.join('')
    },
    err: function(msg) {
      err = 1
      buf.push('/* +++ ERROR +++ ' + msg + ' */\n')
    },
    raw: function(txt) {
      buf.push(txt, '\n')
    },
    atrule: function(rule, kind, param, takesBlock) {
      buf.push(indent, rule, param && ' ', param, takesBlock ? ' {' : ';', '\n')
      if (takesBlock) indent = indent + '    '
    },
    // close atrule
    _atrule: function() {
      indent = indent.slice(4)
      buf.push(indent, '}', '\n')
    },
    rule: function(selector) {
      buf.push(indent, selector, ' {', '\n')
      indent = indent + '    '
    },

    // close rule
    _rule: function() {
      indent = indent.slice(4)
      buf.push(indent, '}', '\n')
    },
    decl: function (prop, value) {buf.push(indent, prop, prop && ': ', value, ';', '\n')}
  }]
}}

var rawstyler = j2c({plugins: [sink]})
var prefixer = j2c({plugins: [j2cPrefixPluginBrowser.prefixPlugin(), sink]})
document.getElementById('source').textContent = '// output without the plugin\n' + rawstyler.sheet(src)
document.getElementById('prefixed').textContent = '//prefixed\n' + prefixer.sheet(src)
</script>
<style>
pre {
    float:left;
    width:49%;
    height:50em;
    font-family: monospace;
}
</style>
<div id="props"></div>
<div id="others"></div>
<script>
function detectOthers(){
  var allStyles = getComputedStyle(document.documentElement, null);
  var styleElement = document.documentElement.appendChild(document.createElement('style'))
  var styleAttr = document.createElement("div").style;

  function supportedRule(selector) {
    styleElement.textContent = selector + '{}'
    return !!styleElement.sheet.cssRules.length
  }
  function supportedDecl(property, value) {
    styleAttr[property] = ''
    styleAttr[property] = value
    return !!styleAttr[property]
  }

  var res = {atrules: {}, functions: {}, keywords: {}, selectors: {}}
  var atrules = {
    'keyframes': 'name',
    'viewport': null,
    'document': 'regexp(".")'
  }

  // build a map of {'@ruleX': '@-prefix-ruleX'}
  for(var atrule in atrules)  {
    res.atrules['@'+atrule] = []
    ;[ "", "-ms-", "-webkit-" ].forEach(function(prefix) {
        if (supportedRule('@' + prefix + atrule + ' ' + (atrules[atrule] || ''))) res.atrules['@'+atrule].push(prefix || "bare");
    })
  }

  var functions = {
    'linear-gradient': {
      property: 'background-image',
      params: 'red, teal'
    },
    'calc': {
      property: 'width',
      params: '1px + 5%'
    },
    'element': {
      property: 'background-image',
      params: '#foo'
    },
    'cross-fade': {
      property: 'backgroundImage',
      params: 'url(a.png), url(b.png), 50%'
    }
  }

  // build an array of prefixable functions
  for (var func in functions) {
    res.functions[func+'()'] = []
    var test = functions[func]
    var property = test.property
    var value = func + '(' + test.params + ')'
    ;[ "", "-ms-", "-webkit-" ].forEach(function(prefix) {
        if (supportedDecl(property, prefix + value)) res.functions[func+'()'].push(prefix || "bare");
    })
  }

  var selectors = {
    ':any-link': null,
    '::backdrop': null,
    ':fullscreen': null, //TODO sort out what changed between specs
    ':full-screen': ':fullscreen',
    //sigh
    '::placeholder': null,
    ':placeholder': '::placeholder',
    '::input-placeholder': '::placeholder',
    ':input-placeholder': '::placeholder',
    ':read-only': null,
    ':read-write': null,
    '::selection': null
  }

  // builds an array of selectors that need a prefix.
  for (selector in selectors) {
    if (selectors[selector] === null){
      res.selectors[selector] = []
      if (supportedRule(selector)) res.selectors[selector].push('bare')
    };
    ['-ms-', '-webkit-'].forEach(function(prefix){
      if (supportedRule(selector.replace(/::?/, function(c){return c + prefix}))) res.selectors[selectors[selector]||selector].push(prefix)
    })
  }

  var kws = {
    'cursor': [ 'grab', 'grabbing', 'zoom-in', 'zoom-out'],
    'display': ['box', 'inline-box', 'flexbox', 'inline-flexbox', 'flex', 'inline-flex', 'grid', 'inline-grid'],
    'position': [ 'sticky' ],
    'width': ['contain-floats', 'fill-available', 'fit-content', 'max-content', 'min-content']
  }


  for (var prop in kws ) {
    kws[prop].forEach(function(kw){
      res.keywords[kw] = [];
      ;[ "", "-ms-", "-webkit-" ].forEach(function(prefix) {
        if (supportedDecl(prop, prefix + kw)) res.keywords[kw].push(prefix || "bare");
      })
    })
  }
  return res
}
others.textContent = JSON.stringify(detectOthers())
</script>